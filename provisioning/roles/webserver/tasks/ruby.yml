---
- stat: path=/etc/profile.d/rvm.sh
  register: rvm

- name: install RVM
  shell: "curl -sSL https://get.rvm.io | bash"
  when: not rvm.stat.exists

- name: check if Ruby version is installed
  shell: "bash -lc 'rvm list'"
  register: ruby_versions

- name: install Ruby
  shell: "bash -lc 'rvm install {{ruby_default}}'"
  when: ruby_versions.stdout.find('{{ruby_default}}') == -1

- name: check if Ruby default version is set
  shell: "bash -lc 'rvm list default'"
  register: ruby_current_default

- name: set default Ruby
  shell: "bash -lc 'rvm --default use {{ruby_default}}'"
  when: ruby_current_default.stdout.find('{{ruby_default}}') == -1

- name: check if gemset exists
  shell: "bash -lc 'rvm gemset list'"
  register: ruby_gemsets

- name: create gemset
  shell: "bash -lc 'rvm {{ruby_default}} do rvm gemset create {{rvm_gemset}}'"
  when: ruby_gemsets.stdout.find('{{rvm_gemset}}') == -1

# - name: install Ruby requirements
#   sudo: yes
#   yum: name={{item}} state=installed
#   with_items:
#     - gcc-c++
#     - patch
#     - readline
#     - readline-devel
#     - zlib
#     - zlib-devel
#     - libyaml-devel
#     - libffi-devel
#     - openssl-devel
#     - make
#     - bzip2
#     - autoconf
#     - automake
#     - libtool
#     - bison
#
# - name: Determine whether ruby-install is installed
#   stat: path=/usr/local/bin/ruby-install
#   register: ruby_install
#
# - name: Download ruby-install
#   get_url: url=https://github.com/postmodern/ruby-install/archive/v0.4.3.tar.gz
#            dest=/tmp/ruby-install-v0.4.3.tar.gz
#   when: not ruby_install.stat.exists
#
# - name: Extract ruby-install
#   command: >
#     chdir=/tmp
#     tar -zxf ruby-install-v0.4.3.tar.gz
#     creates=/tmp/ruby-install-0.4.3
#   when: not ruby_install.stat.exists
#
# - name: Install ruby-install
#   command: >
#     chdir=/tmp/ruby-install-0.4.3
#     creates=/usr/local/bin/ruby-install
#     make install
#   sudo: yes
#   when: not ruby_install.stat.exists
#
# - name: Install rubies
#   command: >
#     chdir=/tmp
#     ruby-install ruby {{item}} --no-reinstall --src-dir /tmp
#   with_items: ruby_versions
#
# - name: Determine whether chruby is installed
#   stat: path=/usr/local/share/chruby/chruby.sh
#   register: chruby
#
# - name: Download chruby
#   get_url: >
#     url=https://github.com/postmodern/chruby/archive/v0.3.8.tar.gz
#     dest=/tmp/chruby-0.3.8.tar.gz
#   when: not chruby.stat.exists
#
# - name: Extract chruby
#   command: >
#     chdir=/tmp
#     tar -zxf chruby-0.3.8.tar.gz
#     creates=/tmp/chruby-0.3.8
#   when: not chruby.stat.exists
#
# - name: Install chruby
#   command: >
#     chdir=/tmp/chruby-0.3.8
#     creates=/usr/local/share/chruby
#     make install
#   sudo: yes
#   when: not chruby.stat.exists
#
# - name: Set default ruby
#   lineinfile: >
#     dest=~/.ruby-version
#     state=present
#     line="ruby-{{ruby_default}}"
#     create=yes
#
# - name: Enable chruby
#   lineinfile: >
#     dest=~/.bash_profile
#     state=present
#     line="source /usr/local/share/chruby/chruby.sh"
#     create=yes
#
# - name: Auto load latest ruby
#   lineinfile: >
#     dest=~/.bash_profile
#     state=present
#     line="source /usr/local/share/chruby/auto.sh"
#     create=yes
#
# - name: Gem list
#   shell: bash -lc 'gem list'
#   register: gem_list
#
# - name: Install default ruby gems
#   command: bash -lc 'gem install {{item}}'
#   when: "'{{item}}' not in '{{gem_list.stdout}}'"
#   with_items:
#     - bundler
#
